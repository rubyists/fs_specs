
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Anatomy of an FS_SPECS Feature Set - 000_phone_infrastructure.feature - FreeSWITCH And FreeSWITCHeR Ruby Library</title>
  <meta name="author" content="Deryl R. Doucette">

  
  <meta name="description" content="FS_SPECS Stable Branch - master As I stated earlier, our ‘master’ branch on GitHub is the ‘Stable Release’ branch for fs_specs. As of today’s date, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://rubyists.github.com/fs_specs/blog/2012/02/16/anatomy-of-an-fs-specs-feature-set-000-phone-infrastructure-feature">
  <link href="/fs_specs/favicon.png" rel="icon">
  <link href="/fs_specs/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/fs_specs/javascripts/modernizr-2.0.js"></script>
  <script src="/fs_specs/javascripts/ender.js"></script>
  <script src="/fs_specs/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/fs_specs/atom.xml" rel="alternate" title="FreeSWITCH And FreeSWITCHeR Ruby Library" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h2><a href="/fs_specs/">FreeSWITCH And FreeSWITCHeR Ruby Library</a></h2>
  
    <h3>A Project for testing FreeSWITCH</h3>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/fs_specs/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:rubyists.github.com/fs_specs" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/fs_specs/">Blog</a></li>
  <li><a href="/fs_specs/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Anatomy of an FS_SPECS Feature Set - 000_phone_infrastructure.feature</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-16T14:44:00-05:00" pubdate data-updated="true">Feb 16<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><h3>FS_SPECS Stable Branch - <a href="https://github.com/rubyists/fs_specs">master</a></h3>

<p>As I stated earlier, our ‘master’ branch on <a href="https://github.com">GitHub</a> is the ‘Stable Release’ branch for fs_specs. As of today’s date, we currently have 4 Features that test different aspects of FreeSWITCH through FreeSWITCHeR. They are:</p>

<ul>
<li>000_phone_infrastructure.feature</li>
<li>001_channel_can_dial_extensions.feature</li>
<li>002_channel_can_interact_with_voicemail.feature</li>
<li>003_can_retrieve_channel_information.feature</li>
</ul>


<p>Over the next few articles I’ll be diving into the anatomy of each feature, the attendant steps, and the <em>FSL::Inbound</em> xxListener classes for each.</p>

<h3>Core Feature - <a href="https://github.com/rubyists/fs_specs/blob/master/features/000_phone_infrastructure.feature">000_phone_infrastructure.feature</a></h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='cucumber'><span class='line'><span class="k">Feature:</span><span class="nf"> Establish that phone infrastructure is working  </span>
</span><span class='line'><span class="nf">If we have 2 properly configured freeswitch servers, </span>
</span><span class='line'><span class="nf">   we want to ensure we can make a connection between the 2 of them,</span>
</span><span class='line'><span class="nf">   and properly terminate that connection.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">   </span><span class="k">Background:</span><span class="nf"> </span>
</span><span class='line'><span class="k">   Given </span><span class="nf">I have </span><span class="s">2</span><span class="nf"> servers named blackbird.rubyists.com and tigershark.rubyists.com</span>
</span><span class='line'><span class="nf">   </span><span class="k">And </span><span class="nf">blackbird.rubyists.com is accessible via the Event Socket</span>
</span><span class='line'>
</span><span class='line'><span class="nf">   </span><span class="k">Scenario:</span><span class="nf"> Show that True and False express correctly, and exactly, with should and should_not</span>
</span><span class='line'><span class="k">   Then </span><span class="nf">true.should == true</span>
</span><span class='line'><span class="nf">   </span><span class="k">And </span><span class="nf"> false.should != true</span>
</span><span class='line'>
</span><span class='line'><span class="nf">   </span><span class="k">Scenario:</span><span class="nf"> </span>
</span><span class='line'><span class="k">   When </span><span class="nf">I make a phone call</span>
</span><span class='line'><span class="nf">   </span><span class="k">Then </span><span class="nf">I should be able to terminate the call</span>
</span></code></pre></td></tr></table></div></figure>


<p>   This feature is the key to the entire set, both existing and those to come. The reason for this is the features job is solely to establish that you have a working configuration for running the rest of the features. If this particular feature fails nothing else will work.</p>

<p>   To see what this feature is actually doing, lets open up the associated <a href="https://github.com/rubyists/fs_specs/blob/master/features/step_definitions/steps.rb">‘steps.rb’</a> file and look for the matchers that comprise each step of each Scenario as they go along. Background in each feature file sets up stuff we need to make it all work and keeps it existing for each Scenario in the feature rather than tearing it all down in-between each one.</p>

<p>   As we can see from the feature title, this feature set establishes that the phone infrastructure for all remaining tests can be found and is correctly configured. In the Background segment’s Given line, we are checking to ensure we can access both machines listed. The first server listed (blackbird.rubyists.com) is a freeswitch that is being used basically as nothing more than a soft phone. The second server listed (tigershark.rubyists.com) is the actual freeswitch being tested. The And line ensures that we can talk to the soft phone (blackbird) via freeswitch’s EventSocket.</p>

<p>   In the first Scenario, we establish the validity of both ‘true’ and ‘false’ values which establishes the credibility of all remaining tests. If ‘true’ and ‘false’ really aren’t what values they say they are, not a chance in the Universe you can be positive any positive or negative results are valid. Since this is our initialization feature, we put it as the first Scenario.</p>

<p>   In the final Scenario, we concretely establish our baseline configuration by ensuring we can originate a call to freeswitch, and that we can, in turn, terminate that call. The steps which comprise this Feature are as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='cucumber'><span class='line'><span class="nf">   </span><span class="k">Background:</span><span class="nf"> </span>
</span><span class='line'><span class="k">   Given </span><span class="nf">/^I have </span><span class="s">2</span><span class="nf"> servers named ([\w.]+) and ([\w.]+)$/ do |server</span><span class="s">1</span><span class="nf">, server</span><span class="s">2</span><span class="nf">|</span>
</span><span class='line'><span class="nf">  </span><span class="nt">@server1,</span><span class="nf"> </span><span class="nt">@server2</span><span class="nf"> = server</span><span class="s">1</span><span class="nf">, server</span><span class="s">2</span><span class="nf"></span>
</span><span class='line'><span class="nt">@sock1</span><span class="nf"> = FSR::CommandSocket.new(server: </span><span class="nt">@server1,</span><span class="nf"> port: </span><span class="s">8021</span><span class="nf">)</span>
</span><span class='line'><span class="nf">  </span><span class="nt">@played_files</span><span class="nf"> = []</span>
</span><span class='line'><span class="nf">  end</span>
</span><span class='line'>
</span><span class='line'><span class="nf">  </span><span class="k">Given </span><span class="nf">/^([\w.]+) is accessible via the Event Socket$/ do |es_server|</span>
</span><span class='line'><span class="nt">@sock2</span><span class="nf"> = FSR::CommandSocket.new(server: </span><span class="nt">@server1)</span><span class="nf"></span>
</span><span class='line'><span class="nf">  </span><span class="nt">@sock2.should_not</span><span class="nf"> be_nil</span>
</span><span class='line'><span class="nf">  end</span>
</span><span class='line'>
</span><span class='line'><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"></span>
</span><span class='line'><span class="k">  Then </span><span class="nf">/^true.should == true$/ do</span>
</span><span class='line'><span class="nf">  true.should == true</span>
</span><span class='line'><span class="nf">  end</span>
</span><span class='line'>
</span><span class='line'><span class="nf">  </span><span class="k">Then </span><span class="nf">/^false.should != true$/ do</span>
</span><span class='line'><span class="nf">  false.should_not == true</span>
</span><span class='line'><span class="nf">  end</span>
</span><span class='line'>
</span><span class='line'><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"></span>
</span><span class='line'><span class="k">  When </span><span class="nf">/^I make a phone call$/ do</span>
</span><span class='line'><span class="nf">orig = </span><span class="nt">@sock2.originate(target:</span><span class="nf"> “sofia/external/</span><span class="s">3000</span><span class="nt">@#{@server2}”,</span><span class="nf"> endpoint: ‘&amp;transfer(</span><span class="s">9664</span><span class="nf">)’)</span>
</span><span class='line'><span class="nf">  </span><span class="nt">@uuid</span><span class="nf"> = orig.run(:api)[‘body’].split[</span><span class="s">1</span><span class="nf">]</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Due to asynchronous nature of the entire method chain</span><span class="nf"></span>
</span><span class='line'><span class="c"># which involves network stack, call plans, etc..</span><span class="nf"></span>
</span><span class='line'><span class="c"># We sleep long enough for the call creations have been handled _throughout_ the stack.</span><span class="nf"></span>
</span><span class='line'><span class="c"># We limit our sleep times to &lt; 1s in order to wait the last amount of time,</span><span class="nf"></span>
</span><span class='line'><span class="c"># and include additional checks oxide the sleep to limit wait time further.</span><span class="nf"></span>
</span><span class='line'><span class="nf">  </span><span class="s">30.</span><span class="nf">times do</span>
</span><span class='line'><span class="nf">  sleep </span><span class="s">0.1</span><span class="nf"></span>
</span><span class='line'><span class="nf">  break if </span><span class="nt">@sock2.calls.run.any?{|call|</span><span class="nf"> call.uuid == </span><span class="nt">@uuid</span><span class="nf"> }</span>
</span><span class='line'><span class="nf">  end</span>
</span><span class='line'><span class="nf">  our_call = </span><span class="nt">@sock2.calls.run.detect</span><span class="nf"> {</span><span class="k"> |</span><span class="s">call</span><span class="k">|</span><span class="s"> call.uuid == @uuid }</span>
</span><span class='line'><span class="s">  fail “No Call Exists!” unless our_call and our_call.uuid == @uuid</span>
</span><span class='line'><span class="s">  end</span>
</span><span class='line'>
</span><span class='line'><span class="s">  Then /^I should be able to terminate the call$/ do</span>
</span><span class='line'><span class="s">  @uuid.should_not be_nil</span>
</span><span class='line'>
</span><span class='line'><span class="s">resp = @sock2.kill(@uuid).run(:api)</span>
</span><span class='line'>
</span><span class='line'><span class="s">resp[“body”].should match(/^\+OK/)</span>
</span><span class='line'>
</span><span class='line'><span class="s">  30.times do</span>
</span><span class='line'><span class="s">  sleep 0.1</span>
</span><span class='line'><span class="s">  break unless @sock2.calls.run.detect {</span><span class="k"> |</span><span class="s">c</span><span class="k">|</span><span class="s"> c.uuid == @uuid }</span>
</span><span class='line'><span class="s">  end</span>
</span><span class='line'><span class="c"># Make sure there are no calls left still dangling</span><span class="s"></span>
</span><span class='line'><span class="s">  @sock2.calls.run.detect {</span><span class="k"> |</span><span class="s">c</span><span class="k">|</span><span class="s"> c.uuid == @uuid }.should be_nil</span>
</span><span class='line'><span class="s">  end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  To distill that all down, in the Background we define several ivars for use elsewhere in the Feature, such as <em>@server1</em>, <em>@server2</em>, and use them to open a <em>FSR::CommandSocket</em> to ‘blackbird’, our ‘soft phone’, named @sock1 after which we promptly ensure it was created (not_nil). This establishes that we have a valid connection between the tests and its requirements.</p>

<p>  Immediately after this we open a second <em>FSR::CommandSocket</em> to ‘blackbird’ for conducting the remainder of this feature’s Scenarios. We also populate a <em>@uuid</em> variable for use elsewhere in identifying related traffic, and connect the endpoint to freeswitch’s Music On Hold extension (MoH) 9664.</p>

<p>  The remainder of the code which is inside the 30.times do has us wait for up to 30 seconds to ensure that our call was actually processed. Items such as network delay, host OS issues, etc all play a part in how response times so we cover our butts a bit here to ensure the call actually got created.</p>

<p>  And finally, we terminal the call in order to show we have functional control over everything. This completes our primary test feature. Now that we know we have network connectivity, that our local testing environment is properly configured, that our truthiness can be trusted, and that we can originate/terminate calls, we can move forward into testing components of FreeSWITCH directly.</p>

<p>  That will be the focus of our next article covering 001_channel_can_dial_extensions.feature. The astute observer will notice a bit of overlap between 000 and 001 insofar as that we are testing the ability to connect to extensions, and we implement that same test twice, once in each feature. That is both on purpose, and due to the nature of establishing that you could actually do something with the established CommandSocket in the 000 feature.</p>

<p>  Thanks for reading!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Deryl R. Doucette</span></span>

      








  


<time datetime="2012-02-16T14:44:00-05:00" pubdate data-updated="true">Feb 16<span>th</span>, 2012</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://rubyists.github.com/fs_specs/blog/2012/02/16/anatomy-of-an-fs-specs-feature-set-000-phone-infrastructure-feature/" data-via="" data-counturl="http://rubyists.github.com/fs_specs/blog/2012/02/16/anatomy-of-an-fs-specs-feature-set-000-phone-infrastructure-feature/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/fs_specs/blog/2012/02/15/stage-fright-gone-brief-synopsis-of-goal/" title="Previous Post: Stage Fright Gone! Brief Synopsis of Goal">&laquo; Stage Fright Gone! Brief Synopsis of Goal</a>
      
      
        <a class="basic-alignment right" href="/fs_specs/blog/2012/02/17/checking-out-extensions-001-channel-can-dial-extensions-feature/" title="Next Post: Checking Out Extensions - 001_channel_can_dial_extensions feature">Checking Out Extensions - 001_channel_can_dial_extensions feature &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/fs_specs/blog/2012/02/22/interacting-with-voicemail-002-channel-can-interact-with-voicemail-feature/">Interacting With Voicemail - 002_channel_can_interact_with_voicemail feature</a>
      </li>
    
      <li class="post">
        <a href="/fs_specs/blog/2012/02/17/checking-out-extensions-001-channel-can-dial-extensions-feature/">Checking Out Extensions - 001_channel_can_dial_extensions feature</a>
      </li>
    
      <li class="post">
        <a href="/fs_specs/blog/2012/02/16/anatomy-of-an-fs-specs-feature-set-000-phone-infrastructure-feature/">Anatomy of an FS_SPECS Feature Set - 000_phone_infrastructure.feature</a>
      </li>
    
      <li class="post">
        <a href="/fs_specs/blog/2012/02/15/stage-fright-gone-brief-synopsis-of-goal/">Stage Fright Gone! Brief Synopsis of Goal</a>
      </li>
    
      <li class="post">
        <a href="/fs_specs/blog/2012/02/15/and-theyre-off-the-start-of-fs-specs/">And They're Off! - The start of FS_SPECS</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/rubyists">@rubyists</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'rubyists',
            count: 7,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/fs_specs/javascripts/github.js" type="text/javascript"> </script>
</section>




<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/114407361520857511779?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Deryl R. Doucette -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
